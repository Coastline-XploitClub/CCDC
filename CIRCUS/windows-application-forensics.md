# Scheduled Tasks
| event id | definition |
| -------- | ---------- |
| 4698     | a scheduled task was created |
| 4702     | a scheduled task was updated |

- can be viewed by eventvwr.msc, wevutil.exe, or Get-WinEvent Get-EventLog
- Assess command to be executed, context, how often or what triggers it, compare to baseline
# Events Generated by Services
| event id | definition |
| -------- | ---------- |
| 7045   | a new service was installed (System) |
| 4967     | a new service was installed (Security) |

## maunally checking scheduled tasks
- check next run time, privileges, triggers, and command.
- can be set with an auto deletion feature
- C:\Windows\System32\Tasks
```powershell
Get-ScheduledTask | ? {$_.Date -ne $null -and $_.State -ne "Disabled"} | sort-object Date | select Date,TaskName,Author,State,TaskPath | ft
# get next run time
Get-ScheduledTask -Taskname <name> | Get-ScheduledTaskInfo
```
## manually checking services
- services.msc
  - look for services set to Automatic Start
  - audit the users the services run as
  - inspect what happens if the service fails (script can be enabled here for persistence)
- registry
  - HKLM\SYSTEM\CurrentControlSet\Services
    - for instance the Amazon SSM service is located at: HKLM\SYSTEM\CurrentControlSet\Services\AmazonSSMAgent
    - right click the key in the left side panel and export to txt file to reveal last write time
      ```powershell
        Key Name:          HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\AmazonSSMAgent
        Class Name:        <NO CLASS>
        Last Write Time:   3/17/2021 - 3:09 PM
      ```
  - Powershell
    - ```
      powershell Get-Service | Where-Object {$_.Status -eq "Running" -and $_.StartType -eq "Automatic"}
      ```
    - github script to get registry last write time [ https://github.com/WiredPulse/PowerShell/blob/master/Registry/Get-RegWriteTime.ps1 ](https://github.com/WiredPulse/PowerShell/blob/master/Registry/Get-RegWriteTime.ps1)
    - Import-Module then...
      ```powershell
                 
      PS C:\Users\Administrator> Import-Module C:\Tools\Get-RegWriteTime.ps1;
      $services = Get-Service | Where-Object {$_.Status -eq "Stopped" -and $_.StartType -eq "Automatic"}
      
      foreach ($service in $services) {
          $serviceName = $service.Name
          $serviceWMI = (Get-WmiObject Win32_Service | Where-Object { $_.Name -eq $serviceName })
          $serviceDisplayName = $service.DisplayName
          $serviceStatus = $service.Status
          $servicePath = $serviceWMI.PathName
          $serviceUser = $serviceWMI.StartName
          $serviceLastWriteTime = Get-Item HKLM:\SYSTEM\CurrentControlSet\Services\$serviceName | Get-RegWriteTime | Select LastWriteTime

            Write-Host "Service Name: $serviceName"
            Write-Host "Display Name: $serviceDisplayName"
            Write-Host "Service Status: $serviceStatus"
            Write-Host "Executable Path: $servicePath"
            Write-Host "User Context: $serviceUser"
            Write-Host "Last Write Time: $serviceLastWriteTime"
            Write-Host ""
        }
```
      # or for a single service do Import-Module then (where $sn is the Get-Service.Name object)
Get-Item HKLM:\SYSTEM\CurrentControlSet\Services\$sn | Get-RegWriteTime | Select LastWriteTime

  ```
## Detecting Browser artifacts
### firefox
- located in AppData\Roaming\Mozilla\Firefox\Profiles
  
| directory | contents | file type |
| --------- | -------- | -------- |
| places.sqlite | browsing history, bookmarks | sqlite |
| logins.json key4.db | creds saved in the browser | json sqlite |
| cookies.sqlite | cookies | sqlite |
| extensions.json | extensions | json |
| favicons.sqlite | favicon metadata | sqlite |
| sessionstore backups | sessions tabs metadata | jasonlz4 |
| formhistory.sqlite | input data | sqlite |

| artefact | description |
| -------- | ----------- |
| url      | url and title |
| visit count | how many times visited |
| last visit date | last date visited |
| typed | if typed in browser or link |

- moz history visits
 
1 - TRANSITION_LINK	The user followed a link and got a new top-level window.

2 - TRANSITION_TYPED 	The user typed the page's URL in the URL bar, selected it from the URL bar autocomplete results, and clicked on it from a history query (from the History sidebar, History menu, or history query in the personal toolbar or Places organiser).

3 - TRANSITION_BOOKMARK 	The user followed a bookmark to get to the page.

4 - TRANSITION_EMBED 	Set when some inner content is loaded. This is true of all images on a page and the iframe's contents. It is also true of any content in a frame, regardless of whether or not the user clicked something to get there.

5 - TRANSITION_REDIRECT_PERMANENT 	The transition was a permanent redirect.

6 - TRANSITION_REDIRECT_TEMPORARY The transition was a temporary redirect.

7 - TRANSITION_DOWNLOAD The transition is a download.

8 - TRANSITION_FRAMED_LINK 	The user followed a link and got a visit in a frame.

9 - TRANSITION_RELOAD 	The page has been reloaded.

- moz annos
  - needs correlation of place id but shows metadata
- check documentation for each applications cookies
### google chrome
- stored in AppData\Local\Google\Chrome\User Data
- User profiles stored in Default
- 
| History    | Contains the browsing history and download metadata.                      | SQLite                             |
|------------|---------------------------------------------------------------------------|------------------------------------|
| Login Data | Contains credentials saved through the browser.                           | SQLite                             |
| Extensions | This directory includes all artefacts related to Chrome extensions.       | Folder (JavaScript and meta files) |
| Cache      | This directory includes cached files stored to optimise the site loading. | Folder                             |
| Sessions   | Handles sessions and tabs metadata.                                       | Folder                             |
| Bookmarks  | Handles bookmark metadata.                                                | JSON                               |
| Web Data   | Contains input data submitted by the user in web forms.                   | SQLite                             |
      
```sqlite3
enumerate tables in a database sqlite3
.tables #or
SELECT 
    name
FROM 
    sqlite_schema
WHERE 
    type ='table' AND 
    name NOT LIKE 'sqlite_%';
# enumerate column names from 'logins'
SELECT name FROM PRAGMA_TABLE_INFO('logins');
```
- Analyze Extensions for malicious ones
  - in C:\users\<user>\AppData\Local\Google\Chrome\User Data\Default\Extensions there are obscured names of extensions each will have a version and a **manifest.json** file with details
  - also there may be javascript files in this directory that you could analyze to determine the extensions functionality
### microsoft edge
- user data stored in AppData\Local\Microsoft\Edge\User Data\Default
#### chromecacheview
- view edge cache using chromecacheview [ https://github.com/Seabreg/chromecacheview ](https://github.com/Seabreg/chromecacheview)
  - select cache file, open
  ![image](https://github.com/Coastline-XploitClub/CCDC/assets/85032657/bc8fc487-252c-41d2-8fdc-0040393874bf)
- Note that the cached metadata can only be considered as a piece of supporting information during investigations. Combining all the information from the other artefacts, such as exact URLs accessed or cookies, is still essential
#### hindsight
[ https://github.com/obsidianforensics/hindsight ](https://github.com/obsidianforensics/hindsight)
- once its up and running you can run sqlite3 queries right in the browser!
  ![image](https://github.com/Coastline-XploitClub/CCDC/assets/85032657/08578743-ae96-4473-994c-7e49a6e4fcc2)
  ```powershell
  Select timestamp,url,title,visit_duration,visit_count,typed_count FROM 'timeline' WHERE type ='url' LIMIT 0,30
  SELECT timestamp,url,title,value FROM timeline WHERE type = 'download' LIMIT 0,30
  # cookie metadata
  SELECT type,origin,key,value FROM 'storage' LIMIT 0,30
  ```
- you can also download the sqlite version of a table
pictured below, query for a specific url found mismatched url and page description

![image](https://github.com/Coastline-XploitClub/CCDC/assets/85032657/4a1e8bca-ab31-47bf-b192-8534b366142e)

### Outlook
- AppData\Local\Microsoft\Outlook\
```powershell
# enumerate all users Directories for Outlook
ls C:\Users\ | foreach {ls "C:\Users\$_\AppData\Local\Microsoft\Outlook\" 2>$null | findstr Directory}
```
- **ost** files in this directory serve as local copies of emails.  These will be synchronized when connected to the internet, so these would be before that.
- use a tool called XstReader to open ost files
  [https://github.com/Dijji/XstReader](https://github.com/Dijji/XstReader)
- phishing is done regularly with attachments so check those
- the cache for opened files is at AppData\Local\Microsoft\Windows\INetCache\Content.Outlook but only before the client is closed
- check links in emails to see if they correlate with other data
- email headers can be seen by selected properties in the bottom corner of Xst Reader
  
  ![image](https://github.com/Coastline-XploitClub/CCDC/assets/85032657/e1217e08-9891-4ed6-ba69-14ce5c6ae17f)
  
  - xmailer may indicate the mail client used
  ## Microsoft Teams
  AppData\Roaming\Microsoft\Teams
- Chat data C:\Users\mike.myers\AppData\Roaming\Microsoft\Teams\IndexedDB\
- .blob and .leveldb need a special parser, a plugin available for Autopsy [https://github.com/lxndrblz/forensicsim](https://github.com/lxndrblz/forensicsim)
- out put in json format
| Record Type | Field Values                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
|-------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| contact     | displayName -  Provides the given name of the email account, which is typically the first and last name of the user. email -  Email address of the contact. mri - Unique identifier of the contact. userPrincipalName - Contains the user principal name of the contact, which is typically the email of the associated user.                                                                                                                                                                                                                                                                                                          |
| message     | conversationId  - Unique identifier of the conversation thread. Combining the messages  with the same ID can retrieve the complete message thread. composetime / createdTime - Timestamp when the message is created. content - The actual message sent. creator - The message's sender in the MRI value. This can be translated by correlating the value in the contact record_type. isFromMe - Provides the direction of the message, whether it was sent or received by the owner of the Teams metadata. properties - Contains additional parameters, such as time of edit (when the message is edited) or file attachment details. |


